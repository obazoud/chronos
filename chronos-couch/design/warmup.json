{
   "_id": "_design/warmup",
   "updates": {
       "warmup": "function (doc, req) {
	       	if(doc.type == \"warmup\"){
		       	if(doc.gamers==0 || doc.gamers==null){
		       		doc.maxGamers= parseInt(req.query.maxGamers);
		       		doc.warmupStart = new Date().getTime();
		       		doc.warmupEnd = doc.warmupStart + parseInt(req.query.warmupDuration);
		       		doc.gamers = 1;
		       		return [doc,\"start\"];
		       	}else{
		       		if(new Date().getTime() < doc.warmupEnd && (doc.gamers + 1) <= doc.maxGamers){
		       			doc.gamers = doc.gamers + 1;
		       			return [doc,\"continue\"];
		       		}else{
		       			return [doc,\"end\"]; 
		       		} 
		       	}
	       	}
       }"
   },
   "language": "javascript",
   "views": {
       "result": {
           "map": "function(doc) {
           		if(doc.type == \"warmup\"){
           			emit(doc.type, [doc.gamers,doc.maxGamers,doc.warmupEnd]);
           		}
           	}",
           "reduce": "function (key, values, rereduce) {
           		var maxGamers = values[0][1];
           		var somme = 0;
           		for(var n = 0; n < values.length; n++){
           			if(values[n][2]!=null && values[n][2] > 0 && new Date().getTime() >= values[n][2]){
           				return \"temps ecoule\";
           			}
           			somme += parseInt(values[n][0]);
           			if(somme >= maxGamers){
           				return \"max gamers atteint\";
           			}
           		}
           		return \"continuez\";
           	}"
       }
   }
}